name: "Daily Maintenance — 银联转账 (23:30–08:00 MYT/GMT+8)"

on:
  schedule:
    # Post 5 minutes before 23:30 MYT start.
    # 23:30 MYT = 15:30 UTC, so post at 15:25 UTC daily.
    - cron: "25 15 * * *"
  workflow_dispatch:

jobs:
  unionpay-maintenance:
    runs-on: ubuntu-latest

    env:
      PAGE_ID: ${{ secrets.STATUSPAGE_PAGE_ID }}
      API_KEY: ${{ secrets.STATUSPAGE_API_KEY }}
      MAINTENANCE_NAME: "银联转账"
      MAINTENANCE_BODY: "提醒：银联转账将于每日 23:30–08:00（MYT/GMT+8）进行例行维护，届时服务可能受限。"
      COMPONENT_CODE: "jb97qs2wnwkk"

    steps:
      - name: Show context (debug)
        shell: bash
        run: |
          echo "Event: ${{ github.event_name }}"
          echo "Run time (UTC): $(date -u +"%Y-%m-%dT%H:%M:%SZ")"
          echo "Run time (MYT): $(TZ=Asia/Kuala_Lumpur date +"%Y-%m-%dT%H:%M:%S%z")"

      - name: Compute scheduled_for and scheduled_until (UTC) — next 23:30→08:00 MYT (pure bash)
        id: times
        shell: bash
        run: |
          set -euo pipefail

          # Current epoch in MYT
          NOW_EPOCH=$(TZ=Asia/Kuala_Lumpur date +%s)

          # Today's 23:30:00 in MYT as epoch
          TODAY_LOCAL_DATE=$(TZ=Asia/Kuala_Lumpur date +%Y-%m-%d)
          TARGET_LOCAL="${TODAY_LOCAL_DATE} 23:30:00"
          TARGET_EPOCH=$(TZ=Asia/Kuala_Lumpur date -d "$TARGET_LOCAL" +%s)

          # If current time is before 23:30 today → start today; else start tomorrow
          if [ "$NOW_EPOCH" -lt "$TARGET_EPOCH" ]; then
            START_EPOCH="$TARGET_EPOCH"
          else
            START_EPOCH=$(( TARGET_EPOCH + 24*3600 ))
          fi

          # END = START + 8h30m
          END_EPOCH=$(( START_EPOCH + 8*3600 + 30*60 ))

          # Format START/END as UTC ISO8601
          START_UTC=$(date -u -d "@$START_EPOCH" +"%Y-%m-%dT%H:%M:%SZ")
          END_UTC=$(date -u -d "@$END_EPOCH"   +"%Y-%m-%dT%H:%M:%SZ")

          echo "start=$START_UTC" >> "$GITHUB_OUTPUT"
          echo "end=$END_UTC"     >> "$GITHUB_OUTPUT"

          echo "银联转账 UTC window: $START_UTC → $END_UTC"

      - name: Pre-check (start/end are in the future and valid)
        shell: bash
        env:
          START: ${{ steps.times.outputs.start }}
          END:   ${{ steps.times.outputs.end }}
        run: |
          set -euo pipefail
          echo "START: $START"
          echo "END:   $END"

          NOW_UTC=$(date -u +"%Y-%m-%dT%H:%M:%SZ")

          to_epoch() { date -u -d "$1" +"%s"; }
          START_EPOCH=$(to_epoch "$START")
          END_EPOCH=$(to_epoch "$END")
          NOW_EPOCH=$(to_epoch "$NOW_UTC")

          if [ "$END_EPOCH" -le "$START_EPOCH" ]; then
            echo "::error ::END must be later than START."
            exit 1
          fi
          if [ "$START_EPOCH" -le "$NOW_EPOCH" ]; then
            echo "::error ::START must be in the future. START=$START NOW=$NOW_UTC"
            exit 1
          fi

          echo "Pre-check OK."

      - name: Create scheduled maintenance via Statuspage API (announce now)
        shell: bash
        env:
          START: ${{ steps.times.outputs.start }}
          END:   ${{ steps.times.outputs.end }}
        run: |
          set -euo pipefail
          echo "Scheduling 银联转账 ${START} -> ${END} (UTC) — posting now"

          FIRST_UPDATE="提前通知：银联转账将于 ${START}（UTC）至 ${END}（UTC）进行例行维护（当地时间 23:30–08:00 MYT/GMT+8）。"

          HTTP_CODE=$(curl -sS -o response.json -w "%{http_code}" \
            "https://api.statuspage.io/v1/pages/${PAGE_ID}/incidents" \
            -H "Authorization: OAuth ${API_KEY}" \
            -H "Content-Type: application/x-www-form-urlencoded" \
            --data-urlencode "incident[name]=${MAINTENANCE_NAME}" \
            --data-urlencode "incident[status]=scheduled" \
            --data-urlencode "incident[body]=${MAINTENANCE_BODY}" \
            --data-urlencode "incident[scheduled_for]=${START}" \
            --data-urlencode "incident[scheduled_until]=${END}" \
            --data-urlencode "incident[deliver_notifications]=true" \
            --data-urlencode "incident[scheduled_auto_in_progress]=true" \
            --data-urlencode "incident[scheduled_auto_completed]=true" \
            --data-urlencode "incident[auto_transition_to_maintenance_state]=true" \
            --data-urlencode "incident[auto_transition_to_operational_state]=true" \
            --data-urlencode "incident[component_ids][]=${COMPONENT_CODE}" \
            --data-urlencode "incident[incident_updates][0][status]=scheduled" \
            --data-urlencode "incident[incident_updates][0][body]=${FIRST_UPDATE}" )

          echo "HTTP status: $HTTP_CODE"
          echo "----- API response -----"
          cat response.json || true
          echo "------------------------"

          if [ "$HTTP_CODE" -ge 300 ]; then
            echo "::error ::Failed to create 银联转账 maintenance. See response above."
            exit 1
          fi

      - name: Summary
        shell: bash
        env:
          START: ${{ steps.times.outputs.start }}
          END:   ${{ steps.times.outputs.end }}
        run: |
          echo "✅ 银联转账 scheduled (23:30–08:00 MYT/GMT+8)."
          echo "Window (UTC): ${START} -> ${END}"
          echo "Component: ${COMPONENT_CODE}"
          echo "Posted now with an initial 'scheduled' update and notifications."
