name: "Daily Maintenance — 银联转账 (23:30–08:00 GMT+8)"

on:
  schedule:
    # Post 5 minutes before 23:30 MYT start -> 23:25 MYT == 15:25 UTC
    - cron: "25 15 * * *"
  workflow_dispatch:

jobs:
  unionpay-transfer-maintenance:
    runs-on: ubuntu-latest

    env:
      PAGE_ID: ${{ secrets.STATUSPAGE_PAGE_ID }}
      API_KEY: ${{ secrets.STATUSPAGE_API_KEY }}

      MAINTENANCE_NAME: "银联转账"
      MAINTENANCE_BODY: "通知：银联转账每日 23:30–08:00（GMT+8）进行常规维护。"
      COMPONENT_CODE: "jb97qs2wnwkk"

    steps:
      - name: Compute scheduled_for / scheduled_until — next 23:30→08:00 (GMT+8)
        id: times
        shell: bash
        run: |
          set -euo pipefail

          # START: Next 23:30 MYT (UTC+8)
          START=$(python3 -c 'from datetime import datetime, time, timedelta; from zoneinfo import ZoneInfo; tz=ZoneInfo("Asia/Kuala_Lumpur"); utc=ZoneInfo("UTC"); now=datetime.now(tz); today_start=datetime.combine(now.date(), time(23,30), tzinfo=tz); start_local=today_start if now < today_start else today_start+timedelta(days=1); print(start_local.astimezone(utc).strftime("%Y-%m-%dT%H:%M:%SZ"))')

          # END: Next day 08:00 MYT
          END=$(python3 -c 'from datetime import datetime, time, timedelta; from zoneinfo import ZoneInfo; tz=ZoneInfo("Asia/Kuala_Lumpur"); utc=ZoneInfo("UTC"); now=datetime.now(tz); today_start=datetime.combine(now.date(), time(23,30), tzinfo=tz); start_local=today_start if now < today_start else today_start+timedelta(days=1); end_local=start_local + timedelta(hours=8, minutes=30); print(end_local.astimezone(utc).strftime("%Y-%m-%dT%H:%M:%SZ"))')

          echo "start=$START" >> "$GITHUB_OUTPUT"
          echo "end=$END"     >> "$GITHUB_OUTPUT"
          echo "银联转账 UTC window: $START → $END"

      - name: Pre-check (start/end are in the future and valid)
        shell: bash
        env:
          START: ${{ steps.times.outputs.start }}
          END:   ${{ steps.times.outputs.end }}
        run: |
          set -euo pipefail
          echo "START: $START"
          echo "END:   $END"
          NOW_UTC=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          to_epoch() { date -u -d "$1" +"%s"; }
          START_EPOCH=$(to_epoch "$START"); END_EPOCH=$(to_epoch "$END"); NOW_EPOCH=$(to_epoch "$NOW_UTC")
          [ "$END_EPOCH" -le "$START_EPOCH" ] && { echo "::error ::END must be later than START."; exit 1; }
          [ "$START_EPOCH" -le "$NOW_EPOCH" ] && { echo "::error ::START must be in the future."; exit 1; }
          echo "Pre-check OK."

      - name: Create scheduled maintenance via Statuspage API
        shell: bash
        env:
          START: ${{ steps.times.outputs.start }}
          END:   ${{ steps.times.outputs.end }}
        run: |
          set -euo pipefail
          echo "Scheduling 银联转账 ${START} -> ${END} (UTC) with component ${COMPONENT_CODE}"

          HTTP_CODE=$(curl -sS -o response.json -w "%{http_code}" \
            "https://api.statuspage.io/v1/pages/${PAGE_ID}/incidents" \
            -H "Authorization: OAuth ${API_KEY}" \
            -H "Content-Type: application/x-www-form-urlencoded" \
            --data-urlencode "incident[name]=${MAINTENANCE_NAME}" \
            --data-urlencode "incident[status]=scheduled" \
            --data-urlencode "incident[body]=${MAINTENANCE_BODY}" \
            --data-urlencode "incident[scheduled_for]=${START}" \
            --data-urlencode "incident[scheduled_until]=${END}" \
            --data-urlencode "incident[scheduled_auto_in_progress]=true" \
            --data-urlencode "incident[scheduled_auto_completed]=true" \
            --data-urlencode "incident[incident_updates][0][status]=scheduled" \
            --data-urlencode "incident[incident_updates][0][affected_components][0][code]=${COMPONENT_CODE}" \
            --data-urlencode "incident[incident_updates][0][affected_components][0][new_status]=under_maintenance" )

          echo "HTTP status: $HTTP_CODE"; cat response.json || true
          [ "$HTTP_CODE" -ge 300 ] && { echo "::error ::Failed to create 银联转账 maintenance."; exit 1; }

      - name: Summary
        shell: bash
        env:
          START: ${{ steps.times.outputs.start }}
          END:   ${{ steps.times.outputs.end }}
        run: |
          echo "✅ 银联转账 scheduled (23:30–08:00 GMT+8)."
          echo "Window (UTC): ${START} -> ${END}"
          echo "Component: ${COMPONENT_CODE}"
