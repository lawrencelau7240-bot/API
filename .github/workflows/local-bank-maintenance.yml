name: "Statuspage — 本地银行 (POST NOW until 08:00 GMT+8)"

on:
  workflow_dispatch:

jobs:
  post-now-local-bank:
    runs-on: ubuntu-latest

    env:
      PAGE_ID: ${{ secrets.STATUSPAGE_PAGE_ID }}
      API_KEY: ${{ secrets.STATUSPAGE_API_KEY }}

      MAINTENANCE_NAME: "本地银行"
      MAINTENANCE_BODY: "【即时维护开始】本地银行正在进行维护（立即开始至本地时间08:00）。"
      COMPONENT_CODE: "jb97qs2wnwkk"

    steps:
      - name: Compute START (now UTC) and END (next 08:00 local → UTC)
        id: times
        shell: bash
        run: |
          set -euo pipefail

          # START: Now in UTC
          START="$(date -u +"%Y-%m-%dT%H:%M:%SZ")"

          # END: Next Asia/Kuala_Lumpur 08:00 converted to UTC
          END=$(python3 -c 'from datetime import datetime, time, timedelta; from zoneinfo import ZoneInfo; tz=ZoneInfo("Asia/Kuala_Lumpur"); utc=ZoneInfo("UTC"); now=datetime.now(tz); target_date = now.date() if now.time() < time(8,0) else (now + timedelta(days=1)).date(); end_local = datetime.combine(target_date, time(8,0), tzinfo=tz); print(end_local.astimezone(utc).strftime("%Y-%m-%dT%H:%M:%SZ"))')

          echo "start=$START" >> "$GITHUB_OUTPUT"
          echo "end=$END"     >> "$GITHUB_OUTPUT"

          echo "本地银行 (POST NOW) — UTC window: $START → $END"

      - name: Create IN-PROGRESS incident NOW via Statuspage API
        shell: bash
        env:
          START: ${{ steps.times.outputs.start }}
          END:   ${{ steps.times.outputs.end }}
        run: |
          set -euo pipefail
          echo "Posting NOW: 本地银行 ${START} -> ${END} (UTC) with component ${COMPONENT_CODE}"

          HTTP_CODE=$(curl -sS -o response.json -w "%{http_code}" \
            "https://api.statuspage.io/v1/pages/${PAGE_ID}/incidents" \
            -H "Authorization: OAuth ${API_KEY}" \
            -H "Content-Type: application/x-www-form-urlencoded" \
            --data-urlencode "incident[name]=${MAINTENANCE_NAME}" \
            --data-urlencode "incident[status]=in_progress" \
            --data-urlencode "incident[body]=${MAINTENANCE_BODY}" \
            --data-urlencode "incident[scheduled_for]=${START}" \
            --data-urlencode "incident[scheduled_until]=${END}" \
            --data-urlencode "incident[incident_updates][0][status]=in_progress" \
            --data-urlencode "incident[incident_updates][0][affected_components][0][code]=${COMPONENT_CODE}" \
            --data-urlencode "incident[incident_updates][0][affected_components][0][new_status]=under_maintenance" )

          echo "HTTP status: $HTTP_CODE"
          cat response.json || true

          if [ "$HTTP_CODE" -ge 300 ]; then
            echo "::error ::Failed to start 本地银行 maintenance NOW. See response above."
            exit 1
          fi

      - name: Summary
        shell: bash
        env:
          START: ${{ steps.times.outputs.start }}
          END:   ${{ steps.times.outputs.end }}
        run: |
          echo "✅ 本地银行 maintenance incident posted NOW."
          echo "Window (UTC): ${START} -> ${END}"
          echo "Component: ${COMPONENT_CODE}"
